name: AI Net Idea Vault - Daily Research Report

on:
  schedule:
    # Twice-daily execution as specified in the plan
    - cron: '0 8 * * *'    # 08:00 UTC morning report
    - cron: '0 20 * * *'   # 20:00 UTC evening report
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  daily_report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          
      - name: Generate research intelligence report
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_ENDPOINT: ${{ secrets.LLM_ENDPOINT }}
          LLM_MODEL: ${{ secrets.LLM_MODEL }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          OLLAMA_ENDPOINT: ${{ secrets.OLLAMA_ENDPOINT }}
          SOURCE_URL: ${{ secrets.SOURCE_URL }}
        run: |
          python scripts/generate_report.py || (echo "Error: Report generation failed" && exit 1)
      
      - name: Build HTML reports from markdown
        run: |
          python scripts/build_reports.py || echo "Warning: HTML build failed, continuing with markdown only"
        continue-on-error: true
      
      - name: Update report index
        run: |
          python scripts/generate_report_index.py || echo "Warning: Index update failed"
        continue-on-error: true
      
      - name: Publish to NOSTR
        env:
          NOSTR_PRIVATE_KEY: ${{ secrets.NOSTR_PRIVATE_KEY }}
        run: |
          python scripts/publish_nostr.py
        continue-on-error: true
          
      - name: Commit and push report
        id: commit
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "feat(report): daily research intelligence $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger GrumpiBlogged webhook
        if: steps.commit.outputs.committed == 'true'
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/Grumpified-OGGVCT/GrumpiBlogged/dispatches \
            -d '{"event_type":"ai-research-daily-update"}'
          echo "âœ… Notified GrumpiBlogged of new report"


